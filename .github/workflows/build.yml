name: Build RPM and DEB Packages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Debug - Show files before build
      run: |
        echo "=== Files before build ==="
        ls -la
        echo "=== Debian files ==="
        ls -la debian/

    - name: Build DEB package
      run: |
        sudo apt update
        sudo apt install -y devscripts debhelper build-essential
        dpkg-buildpackage -us -uc

    - name: Debug - Show files after build
      run: |
        echo "=== Files after build ==="
        ls -la
        echo "=== Files one level up ==="
        ls -la ../
        echo "=== All deb files ==="
        find . -name "*.deb" -o -name "../*.deb"

    - name: Upload DEB artifact
      uses: actions/upload-artifact@v4
      with:
        name: count-files-deb
        path: "*.deb"

  build-rpm:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install RPM tools
      run: |
        sudo apt update
        sudo apt install -y rpm

    - name: Build RPM package
      run: |
        mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
        cp count_files.sh ~/rpmbuild/SOURCES/
        cp rpm/count_files.spec ~/rpmbuild/SPECS/
        rpmbuild -ba ~/rpmbuild/SPECS/count_files.spec

    - name: Upload RPM artifact
      uses: actions/upload-artifact@v4
      with:
        name: count-files-rpm
        path: "*.rpm"
